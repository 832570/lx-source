## Lx-Source/更新日志

#### \# 2024-01-10 v1.0.2-b10-d1 (dev)
<!-- + 内置kw接口失效，暂时禁用kw源 -->
+ 修复内置kw接口

#### \# 2024-01-07 v1.0.2-b0.9 (beta)
<!-- + 不再导出 `public` 目录，源脚本统一到 `/lx-custom-source.js` 获取
+ 为每个源单独设置直链缓存时间 -->
+ 开启tx源账号解析时启用文件缓存
+ 移植tx源刷新登录功能
+ 注：之前没有登录过手机qq音乐的账号签到可免费领绿钻会员
+ **已知问题：生成直链会暴露uin且无法移除，共享时请务必使用缓存**
+ 完善速率限制功能：增加容忍限度、封禁时间，详见配置注释
+ 准备弃用"MusicId-字符串"传附加参数的方式
+ 计划：重构音质对应表部分，每个源使用独立音质表
+ 更换wy内置接口为qz源
+ 默认监听地址改为127.0.0.1
<!-- + *内置接口失效，暂时禁用wy源 (如恢复可修改 [Custom].Wy_Enable=true)* -->

#### \# 2024-01-01 v1.0.2-b0.8 (beta)
+ 注：新年第一次更新，祝大家听歌愉快
- 根据源启用状态生成支持音质表

#### \# 2023-12-31 v1.0.2-b0.8.2 (dev)
- 注：本次还是累积更新，不单独发布Release
+ 从Python版移植部分代码
+ (兼容tx源一分钟试听链接获取)
+ 优化速率限制相关逻辑

#### 2023-12-30 v1.0.2-b0.8.1 (dev)
+ 注：本次累积更新，不单独发布Release
+ 实现单ip速率限制，配置方法：
   - **[Auth].RateLimit**
   * _Enable(false): 开启功能
   * _Block(30): 单位时间
   * _Single(15): 单ip限制次数
   - 实际速率: 15次每30秒
+ (目前仅对解析接口使用，文件接口不受限制)

#### 2023-12-25 v1.0.2-b0.7 (beta)
<!-- + 支持调用 ffmpeg 恢复kg一分钟试听数据真实长度
+ (测试版，需要Path里有ffmpeg命令，配置文件 [Main].FFConv=true 开启) -->
+ 修复tx试听源，获取128k音质 (原先默认获取的是96k的m4a)
+ **很不幸，又要更新客户端脚本了...**
+ (要不直接把musicinfo Post到服务端处理吧)

### 2023-12-24 v1.0.2-b0.6 (beta)
#### 功能:
<!-- + 将试听接口独立为直连接口，其它源未实现的自动回退到此接口 (可在配置中关闭) -->
+ 添加tx试听源(同样不计入缓存)
+ [不兼容] 支持使用服务端返回音质列表
#### 注:
+ **请再次更新客户端脚本！**
+ 支持从服务端获取内置脚本: http://127.0.0.1:1011/lx-custom-source.js
#### 已知问题:
+ kg试听源返回1分钟试听文件会错误识别成完整版，导致播放器卡死

#### **2023-12-23 v1.0.2-b0.5 (beta)**
<!-- + zTool:
   - 修复直接传入make([]byte, n)时潜在内存泄露问题 -->
### update:
- 请求解析接口时遇到的错误输出到log，不返回msg
<!-- - 服务端返回音质列表(需更新脚本) -->
### feature:
- 添加kg试听源(不计入缓存) **\*(需更新脚本)**
- 注：部分歌曲只能试听前1分钟内容，无法试听的无法播放
- (请手动删除 `data/public` 目录后启动程序重新释放静态资源)
- 脚本还是 `data/public/lx-coustom-source.js`，开了Key验证的记得将原apipass复制过去
### bugfix:
- 修复wy源返回错误判断逻辑
<!-- + [msg] 当前api结构与动态链实现方式不兼容，需要大改，故推迟更新 -->

#### 2023-12-22 v1.0.2-b0.4 (beta)
<!-- + 没有功能更新，几个未来的想法
   - 利用缓存信息制作数据库，可通过api搜索音乐
   - 修改Lx-Music支持通过脚本新增搜索源 -->
+ update 更新:
   - 给CacheQuery加个sync.Pool，提高并发分配效率
   - 请求验证改为在初始化时载入，降低每次判断性能损耗
   <!-- - (现在内存缓存和文件缓存的响应速度差距约为200µs) -->
+ feature 功能:
   - 临时链生成仍将推迟
+ bugfix 修复:
   - 临时解决预定义(*Loger).NewGroup()无法输出到FileLoger问题
+ 注：
   - 如果非调试使用建议关闭控制台日志输出 [Main].Print=false，可少量提升io性能 (不影响文件日志记录)

#### 2023-12-19 1.0.2-b0.3 (dev)
+ 增加dev分支，日常开发，稳定了再合main，防止临时补充更新情况
+ 上次补充更新内容：将error.mp3换成远程连接
   - 洛雪客户端似乎无法识别Base64编码后的音频文件
   - 待解决问题：无法获取真实请求URL，如套一层Nginx或分路径反代，只能依赖手动配置的 [Cache].Local_Bind 确定外部地址
+ zTool:
   - 略微降低FileLogs缓存大小，防止异常退出丢**太多**日志情况 (TODO: Error及以上情况强制刷新缓冲区)
   - cmd: 优化io.Copy缓存问题
+ (未完成) 临时链生成功能 (需要维护双倍的映射表，实际速度可能减慢)
+ (实验性) [Main].SysLev 尝试调高程序优先级以解决windows下最小化降低资源分配问题

#### 2023-12-(17-18) 1.0.2-β0.2 (beta)
+ 脚本增加请求耗时输出
+ 优化zTool文件下载逻辑
+ 链接缓存由Source上移至Router级 (为临时链实现基础)
+ 完善缓存规则
   - 查询成功将链接写入内存，保留一小时 (MemCache HIT)
   - 解析错误将空字符串写入内存，阻止请求10分钟 (MemCache Reject)
   + 可提升后续重复查询响应速度 (实际效果不明显，后端几十µs的差距)
+ 防止自动换源机制瞎查，解析失败返回一段提示语音
   ```
   非常抱歉，
   本音频可能由以下原因导致无法正常播放，

   不支持的平台或音质，
   触发风控或专辑单独收费，
   缓存文件已被删除，
   实际音质不匹配，

   --洛雪自定义源
   （Lx-Source）
   ```
#### ~2023-12-16
+ 参考Python版移植部分功能
+ 完善、优化逻辑
+ 发布源码
#### 2023-10-21
+ 立项制作
